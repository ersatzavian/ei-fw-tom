/*
Copyright (C) 2014 electric imp, inc.

Permission is hereby granted, free of charge, to any person obtaining a copy of this software 
and associated documentation files (the "Software"), to deal in the Software without restriction, 
including without limitation the rights to use, copy, modify, merge, publish, distribute, 
sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is 
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial 
portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, 
INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE 
AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, 
DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, 
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/

/* WS2812 "Neopixel" LED Driver
 * 
 * Uses SPI to emulate 1-wire
 * http://learn.adafruit.com/adafruit-neopixel-uberguide/advanced-coding
 *
 */
 
/* CONSTS AND GLOBALS --------------------------------------------------------*/

// constants for using SPI to emulate 1-wire
const BYTESPERPIXEL = 27;
const BYTESPERCOLOR = 9; // BYTESPERPIXEL / 3
const SPICLK = 7500; // SPI clock speed in kHz

// this string contains the "equivalent waveform" to send the numbers 0-255 over SPI at 7.5MHz.
// 9 bytes of string are required to send 1 byte of emulated 1-wire data. 
// For example, to add a byte containing the number "14" to the frame:
// bits.slice(14 * 9, (14 * 9) + 9);
bits <- ["\xE0\x70\x38\x1C\x0E\x07\x03\x81\xC0",
                "\xE0\x70\x38\x1C\x0E\x07\x03\x81\xF8",
                "\xE0\x70\x38\x1C\x0E\x07\x03\xF1\xC0",
                "\xE0\x70\x38\x1C\x0E\x07\x03\xF1\xF8",
                "\xE0\x70\x38\x1C\x0E\x07\xE3\x81\xC0",
                "\xE0\x70\x38\x1C\x0E\x07\xE3\x81\xF8",
                "\xE0\x70\x38\x1C\x0E\x07\xE3\xF1\xC0",
                "\xE0\x70\x38\x1C\x0E\x07\xE3\xF1\xF8",
                "\xE0\x70\x38\x1C\x0F\xC7\x03\x81\xC0",
                "\xE0\x70\x38\x1C\x0F\xC7\x03\x81\xF8",
                "\xE0\x70\x38\x1C\x0F\xC7\x03\xF1\xC0",
                "\xE0\x70\x38\x1C\x0F\xC7\x03\xF1\xF8",
                "\xE0\x70\x38\x1C\x0F\xC7\xE3\x81\xC0",
                "\xE0\x70\x38\x1C\x0F\xC7\xE3\x81\xF8",
                "\xE0\x70\x38\x1C\x0F\xC7\xE3\xF1\xC0",
                "\xE0\x70\x38\x1C\x0F\xC7\xE3\xF1\xF8",
                "\xE0\x70\x38\x1F\x8E\x07\x03\x81\xC0",
                "\xE0\x70\x38\x1F\x8E\x07\x03\x81\xF8",
                "\xE0\x70\x38\x1F\x8E\x07\x03\xF1\xC0",
                "\xE0\x70\x38\x1F\x8E\x07\x03\xF1\xF8",
                "\xE0\x70\x38\x1F\x8E\x07\xE3\x81\xC0",
                "\xE0\x70\x38\x1F\x8E\x07\xE3\x81\xF8",
                "\xE0\x70\x38\x1F\x8E\x07\xE3\xF1\xC0",
                "\xE0\x70\x38\x1F\x8E\x07\xE3\xF1\xF8",
                "\xE0\x70\x38\x1F\x8F\xC7\x03\x81\xC0",
                "\xE0\x70\x38\x1F\x8F\xC7\x03\x81\xF8",
                "\xE0\x70\x38\x1F\x8F\xC7\x03\xF1\xC0",
                "\xE0\x70\x38\x1F\x8F\xC7\x03\xF1\xF8",
                "\xE0\x70\x38\x1F\x8F\xC7\xE3\x81\xC0",
                "\xE0\x70\x38\x1F\x8F\xC7\xE3\x81\xF8",
                "\xE0\x70\x38\x1F\x8F\xC7\xE3\xF1\xC0",
                "\xE0\x70\x38\x1F\x8F\xC7\xE3\xF1\xF8",
                "\xE0\x70\x3F\x1C\x0E\x07\x03\x81\xC0",
                "\xE0\x70\x3F\x1C\x0E\x07\x03\x81\xF8",
                "\xE0\x70\x3F\x1C\x0E\x07\x03\xF1\xC0",
                "\xE0\x70\x3F\x1C\x0E\x07\x03\xF1\xF8",
                "\xE0\x70\x3F\x1C\x0E\x07\xE3\x81\xC0",
                "\xE0\x70\x3F\x1C\x0E\x07\xE3\x81\xF8",
                "\xE0\x70\x3F\x1C\x0E\x07\xE3\xF1\xC0",
                "\xE0\x70\x3F\x1C\x0E\x07\xE3\xF1\xF8",
                "\xE0\x70\x3F\x1C\x0F\xC7\x03\x81\xC0",
                "\xE0\x70\x3F\x1C\x0F\xC7\x03\x81\xF8",
                "\xE0\x70\x3F\x1C\x0F\xC7\x03\xF1\xC0",
                "\xE0\x70\x3F\x1C\x0F\xC7\x03\xF1\xF8",
                "\xE0\x70\x3F\x1C\x0F\xC7\xE3\x81\xC0",
                "\xE0\x70\x3F\x1C\x0F\xC7\xE3\x81\xF8",
                "\xE0\x70\x3F\x1C\x0F\xC7\xE3\xF1\xC0",
                "\xE0\x70\x3F\x1C\x0F\xC7\xE3\xF1\xF8",
                "\xE0\x70\x3F\x1F\x8E\x07\x03\x81\xC0",
                "\xE0\x70\x3F\x1F\x8E\x07\x03\x81\xF8",
                "\xE0\x70\x3F\x1F\x8E\x07\x03\xF1\xC0",
                "\xE0\x70\x3F\x1F\x8E\x07\x03\xF1\xF8",
                "\xE0\x70\x3F\x1F\x8E\x07\xE3\x81\xC0",
                "\xE0\x70\x3F\x1F\x8E\x07\xE3\x81\xF8",
                "\xE0\x70\x3F\x1F\x8E\x07\xE3\xF1\xC0",
                "\xE0\x70\x3F\x1F\x8E\x07\xE3\xF1\xF8",
                "\xE0\x70\x3F\x1F\x8F\xC7\x03\x81\xC0",
                "\xE0\x70\x3F\x1F\x8F\xC7\x03\x81\xF8",
                "\xE0\x70\x3F\x1F\x8F\xC7\x03\xF1\xC0",
                "\xE0\x70\x3F\x1F\x8F\xC7\x03\xF1\xF8",
                "\xE0\x70\x3F\x1F\x8F\xC7\xE3\x81\xC0",
                "\xE0\x70\x3F\x1F\x8F\xC7\xE3\x81\xF8",
                "\xE0\x70\x3F\x1F\x8F\xC7\xE3\xF1\xC0",
                "\xE0\x70\x3F\x1F\x8F\xC7\xE3\xF1\xF8",
                "\xE0\x7E\x38\x1C\x0E\x07\x03\x81\xC0",
                "\xE0\x7E\x38\x1C\x0E\x07\x03\x81\xF8",
                "\xE0\x7E\x38\x1C\x0E\x07\x03\xF1\xC0",
                "\xE0\x7E\x38\x1C\x0E\x07\x03\xF1\xF8",
                "\xE0\x7E\x38\x1C\x0E\x07\xE3\x81\xC0",
                "\xE0\x7E\x38\x1C\x0E\x07\xE3\x81\xF8",
                "\xE0\x7E\x38\x1C\x0E\x07\xE3\xF1\xC0",
                "\xE0\x7E\x38\x1C\x0E\x07\xE3\xF1\xF8",
                "\xE0\x7E\x38\x1C\x0F\xC7\x03\x81\xC0",
                "\xE0\x7E\x38\x1C\x0F\xC7\x03\x81\xF8",
                "\xE0\x7E\x38\x1C\x0F\xC7\x03\xF1\xC0",
                "\xE0\x7E\x38\x1C\x0F\xC7\x03\xF1\xF8",
                "\xE0\x7E\x38\x1C\x0F\xC7\xE3\x81\xC0",
                "\xE0\x7E\x38\x1C\x0F\xC7\xE3\x81\xF8",
                "\xE0\x7E\x38\x1C\x0F\xC7\xE3\xF1\xC0",
                "\xE0\x7E\x38\x1C\x0F\xC7\xE3\xF1\xF8",
                "\xE0\x7E\x38\x1F\x8E\x07\x03\x81\xC0",
                "\xE0\x7E\x38\x1F\x8E\x07\x03\x81\xF8",
                "\xE0\x7E\x38\x1F\x8E\x07\x03\xF1\xC0",
                "\xE0\x7E\x38\x1F\x8E\x07\x03\xF1\xF8",
                "\xE0\x7E\x38\x1F\x8E\x07\xE3\x81\xC0",
                "\xE0\x7E\x38\x1F\x8E\x07\xE3\x81\xF8",
                "\xE0\x7E\x38\x1F\x8E\x07\xE3\xF1\xC0",
                "\xE0\x7E\x38\x1F\x8E\x07\xE3\xF1\xF8",
                "\xE0\x7E\x38\x1F\x8F\xC7\x03\x81\xC0",
                "\xE0\x7E\x38\x1F\x8F\xC7\x03\x81\xF8",
                "\xE0\x7E\x38\x1F\x8F\xC7\x03\xF1\xC0",
                "\xE0\x7E\x38\x1F\x8F\xC7\x03\xF1\xF8",
                "\xE0\x7E\x38\x1F\x8F\xC7\xE3\x81\xC0",
                "\xE0\x7E\x38\x1F\x8F\xC7\xE3\x81\xF8",
                "\xE0\x7E\x38\x1F\x8F\xC7\xE3\xF1\xC0",
                "\xE0\x7E\x38\x1F\x8F\xC7\xE3\xF1\xF8",
                "\xE0\x7E\x3F\x1C\x0E\x07\x03\x81\xC0",
                "\xE0\x7E\x3F\x1C\x0E\x07\x03\x81\xF8",
                "\xE0\x7E\x3F\x1C\x0E\x07\x03\xF1\xC0",
                "\xE0\x7E\x3F\x1C\x0E\x07\x03\xF1\xF8",
                "\xE0\x7E\x3F\x1C\x0E\x07\xE3\x81\xC0",
                "\xE0\x7E\x3F\x1C\x0E\x07\xE3\x81\xF8",
                "\xE0\x7E\x3F\x1C\x0E\x07\xE3\xF1\xC0",
                "\xE0\x7E\x3F\x1C\x0E\x07\xE3\xF1\xF8",
                "\xE0\x7E\x3F\x1C\x0F\xC7\x03\x81\xC0",
                "\xE0\x7E\x3F\x1C\x0F\xC7\x03\x81\xF8",
                "\xE0\x7E\x3F\x1C\x0F\xC7\x03\xF1\xC0",
                "\xE0\x7E\x3F\x1C\x0F\xC7\x03\xF1\xF8",
                "\xE0\x7E\x3F\x1C\x0F\xC7\xE3\x81\xC0",
                "\xE0\x7E\x3F\x1C\x0F\xC7\xE3\x81\xF8",
                "\xE0\x7E\x3F\x1C\x0F\xC7\xE3\xF1\xC0",
                "\xE0\x7E\x3F\x1C\x0F\xC7\xE3\xF1\xF8",
                "\xE0\x7E\x3F\x1F\x8E\x07\x03\x81\xC0",
                "\xE0\x7E\x3F\x1F\x8E\x07\x03\x81\xF8",
                "\xE0\x7E\x3F\x1F\x8E\x07\x03\xF1\xC0",
                "\xE0\x7E\x3F\x1F\x8E\x07\x03\xF1\xF8",
                "\xE0\x7E\x3F\x1F\x8E\x07\xE3\x81\xC0",
                "\xE0\x7E\x3F\x1F\x8E\x07\xE3\x81\xF8",
                "\xE0\x7E\x3F\x1F\x8E\x07\xE3\xF1\xC0",
                "\xE0\x7E\x3F\x1F\x8E\x07\xE3\xF1\xF8",
                "\xE0\x7E\x3F\x1F\x8F\xC7\x03\x81\xC0",
                "\xE0\x7E\x3F\x1F\x8F\xC7\x03\x81\xF8",
                "\xE0\x7E\x3F\x1F\x8F\xC7\x03\xF1\xC0",
                "\xE0\x7E\x3F\x1F\x8F\xC7\x03\xF1\xF8",
                "\xE0\x7E\x3F\x1F\x8F\xC7\xE3\x81\xC0",
                "\xE0\x7E\x3F\x1F\x8F\xC7\xE3\x81\xF8",
                "\xE0\x7E\x3F\x1F\x8F\xC7\xE3\xF1\xC0",
                "\xE0\x7E\x3F\x1F\x8F\xC7\xE3\xF1\xF8",
                "\xFC\x70\x38\x1C\x0E\x07\x03\x81\xC0",
                "\xFC\x70\x38\x1C\x0E\x07\x03\x81\xF8",
                "\xFC\x70\x38\x1C\x0E\x07\x03\xF1\xC0",
                "\xFC\x70\x38\x1C\x0E\x07\x03\xF1\xF8",
                "\xFC\x70\x38\x1C\x0E\x07\xE3\x81\xC0",
                "\xFC\x70\x38\x1C\x0E\x07\xE3\x81\xF8",
                "\xFC\x70\x38\x1C\x0E\x07\xE3\xF1\xC0",
                "\xFC\x70\x38\x1C\x0E\x07\xE3\xF1\xF8",
                "\xFC\x70\x38\x1C\x0F\xC7\x03\x81\xC0",
                "\xFC\x70\x38\x1C\x0F\xC7\x03\x81\xF8",
                "\xFC\x70\x38\x1C\x0F\xC7\x03\xF1\xC0",
                "\xFC\x70\x38\x1C\x0F\xC7\x03\xF1\xF8",
                "\xFC\x70\x38\x1C\x0F\xC7\xE3\x81\xC0",
                "\xFC\x70\x38\x1C\x0F\xC7\xE3\x81\xF8",
                "\xFC\x70\x38\x1C\x0F\xC7\xE3\xF1\xC0",
                "\xFC\x70\x38\x1C\x0F\xC7\xE3\xF1\xF8",
                "\xFC\x70\x38\x1F\x8E\x07\x03\x81\xC0",
                "\xFC\x70\x38\x1F\x8E\x07\x03\x81\xF8",
                "\xFC\x70\x38\x1F\x8E\x07\x03\xF1\xC0",
                "\xFC\x70\x38\x1F\x8E\x07\x03\xF1\xF8",
                "\xFC\x70\x38\x1F\x8E\x07\xE3\x81\xC0",
                "\xFC\x70\x38\x1F\x8E\x07\xE3\x81\xF8",
                "\xFC\x70\x38\x1F\x8E\x07\xE3\xF1\xC0",
                "\xFC\x70\x38\x1F\x8E\x07\xE3\xF1\xF8",
                "\xFC\x70\x38\x1F\x8F\xC7\x03\x81\xC0",
                "\xFC\x70\x38\x1F\x8F\xC7\x03\x81\xF8",
                "\xFC\x70\x38\x1F\x8F\xC7\x03\xF1\xC0",
                "\xFC\x70\x38\x1F\x8F\xC7\x03\xF1\xF8",
                "\xFC\x70\x38\x1F\x8F\xC7\xE3\x81\xC0",
                "\xFC\x70\x38\x1F\x8F\xC7\xE3\x81\xF8",
                "\xFC\x70\x38\x1F\x8F\xC7\xE3\xF1\xC0",
                "\xFC\x70\x38\x1F\x8F\xC7\xE3\xF1\xF8",
                "\xFC\x70\x3F\x1C\x0E\x07\x03\x81\xC0",
                "\xFC\x70\x3F\x1C\x0E\x07\x03\x81\xF8",
                "\xFC\x70\x3F\x1C\x0E\x07\x03\xF1\xC0",
                "\xFC\x70\x3F\x1C\x0E\x07\x03\xF1\xF8",
                "\xFC\x70\x3F\x1C\x0E\x07\xE3\x81\xC0",
                "\xFC\x70\x3F\x1C\x0E\x07\xE3\x81\xF8",
                "\xFC\x70\x3F\x1C\x0E\x07\xE3\xF1\xC0",
                "\xFC\x70\x3F\x1C\x0E\x07\xE3\xF1\xF8",
                "\xFC\x70\x3F\x1C\x0F\xC7\x03\x81\xC0",
                "\xFC\x70\x3F\x1C\x0F\xC7\x03\x81\xF8",
                "\xFC\x70\x3F\x1C\x0F\xC7\x03\xF1\xC0",
                "\xFC\x70\x3F\x1C\x0F\xC7\x03\xF1\xF8",
                "\xFC\x70\x3F\x1C\x0F\xC7\xE3\x81\xC0",
                "\xFC\x70\x3F\x1C\x0F\xC7\xE3\x81\xF8",
                "\xFC\x70\x3F\x1C\x0F\xC7\xE3\xF1\xC0",
                "\xFC\x70\x3F\x1C\x0F\xC7\xE3\xF1\xF8",
                "\xFC\x70\x3F\x1F\x8E\x07\x03\x81\xC0",
                "\xFC\x70\x3F\x1F\x8E\x07\x03\x81\xF8",
                "\xFC\x70\x3F\x1F\x8E\x07\x03\xF1\xC0",
                "\xFC\x70\x3F\x1F\x8E\x07\x03\xF1\xF8",
                "\xFC\x70\x3F\x1F\x8E\x07\xE3\x81\xC0",
                "\xFC\x70\x3F\x1F\x8E\x07\xE3\x81\xF8",
                "\xFC\x70\x3F\x1F\x8E\x07\xE3\xF1\xC0",
                "\xFC\x70\x3F\x1F\x8E\x07\xE3\xF1\xF8",
                "\xFC\x70\x3F\x1F\x8F\xC7\x03\x81\xC0",
                "\xFC\x70\x3F\x1F\x8F\xC7\x03\x81\xF8",
                "\xFC\x70\x3F\x1F\x8F\xC7\x03\xF1\xC0",
                "\xFC\x70\x3F\x1F\x8F\xC7\x03\xF1\xF8",
                "\xFC\x70\x3F\x1F\x8F\xC7\xE3\x81\xC0",
                "\xFC\x70\x3F\x1F\x8F\xC7\xE3\x81\xF8",
                "\xFC\x70\x3F\x1F\x8F\xC7\xE3\xF1\xC0",
                "\xFC\x70\x3F\x1F\x8F\xC7\xE3\xF1\xF8",
                "\xFC\x7E\x38\x1C\x0E\x07\x03\x81\xC0",
                "\xFC\x7E\x38\x1C\x0E\x07\x03\x81\xF8",
                "\xFC\x7E\x38\x1C\x0E\x07\x03\xF1\xC0",
                "\xFC\x7E\x38\x1C\x0E\x07\x03\xF1\xF8",
                "\xFC\x7E\x38\x1C\x0E\x07\xE3\x81\xC0",
                "\xFC\x7E\x38\x1C\x0E\x07\xE3\x81\xF8",
                "\xFC\x7E\x38\x1C\x0E\x07\xE3\xF1\xC0",
                "\xFC\x7E\x38\x1C\x0E\x07\xE3\xF1\xF8",
                "\xFC\x7E\x38\x1C\x0F\xC7\x03\x81\xC0",
                "\xFC\x7E\x38\x1C\x0F\xC7\x03\x81\xF8",
                "\xFC\x7E\x38\x1C\x0F\xC7\x03\xF1\xC0",
                "\xFC\x7E\x38\x1C\x0F\xC7\x03\xF1\xF8",
                "\xFC\x7E\x38\x1C\x0F\xC7\xE3\x81\xC0",
                "\xFC\x7E\x38\x1C\x0F\xC7\xE3\x81\xF8",
                "\xFC\x7E\x38\x1C\x0F\xC7\xE3\xF1\xC0",
                "\xFC\x7E\x38\x1C\x0F\xC7\xE3\xF1\xF8",
                "\xFC\x7E\x38\x1F\x8E\x07\x03\x81\xC0",
                "\xFC\x7E\x38\x1F\x8E\x07\x03\x81\xF8",
                "\xFC\x7E\x38\x1F\x8E\x07\x03\xF1\xC0",
                "\xFC\x7E\x38\x1F\x8E\x07\x03\xF1\xF8",
                "\xFC\x7E\x38\x1F\x8E\x07\xE3\x81\xC0",
                "\xFC\x7E\x38\x1F\x8E\x07\xE3\x81\xF8",
                "\xFC\x7E\x38\x1F\x8E\x07\xE3\xF1\xC0",
                "\xFC\x7E\x38\x1F\x8E\x07\xE3\xF1\xF8",
                "\xFC\x7E\x38\x1F\x8F\xC7\x03\x81\xC0",
                "\xFC\x7E\x38\x1F\x8F\xC7\x03\x81\xF8",
                "\xFC\x7E\x38\x1F\x8F\xC7\x03\xF1\xC0",
                "\xFC\x7E\x38\x1F\x8F\xC7\x03\xF1\xF8",
                "\xFC\x7E\x38\x1F\x8F\xC7\xE3\x81\xC0",
                "\xFC\x7E\x38\x1F\x8F\xC7\xE3\x81\xF8",
                "\xFC\x7E\x38\x1F\x8F\xC7\xE3\xF1\xC0",
                "\xFC\x7E\x38\x1F\x8F\xC7\xE3\xF1\xF8",
                "\xFC\x7E\x3F\x1C\x0E\x07\x03\x81\xC0",
                "\xFC\x7E\x3F\x1C\x0E\x07\x03\x81\xF8",
                "\xFC\x7E\x3F\x1C\x0E\x07\x03\xF1\xC0",
                "\xFC\x7E\x3F\x1C\x0E\x07\x03\xF1\xF8",
                "\xFC\x7E\x3F\x1C\x0E\x07\xE3\x81\xC0",
                "\xFC\x7E\x3F\x1C\x0E\x07\xE3\x81\xF8",
                "\xFC\x7E\x3F\x1C\x0E\x07\xE3\xF1\xC0",
                "\xFC\x7E\x3F\x1C\x0E\x07\xE3\xF1\xF8",
                "\xFC\x7E\x3F\x1C\x0F\xC7\x03\x81\xC0",
                "\xFC\x7E\x3F\x1C\x0F\xC7\x03\x81\xF8",
                "\xFC\x7E\x3F\x1C\x0F\xC7\x03\xF1\xC0",
                "\xFC\x7E\x3F\x1C\x0F\xC7\x03\xF1\xF8",
                "\xFC\x7E\x3F\x1C\x0F\xC7\xE3\x81\xC0",
                "\xFC\x7E\x3F\x1C\x0F\xC7\xE3\x81\xF8",
                "\xFC\x7E\x3F\x1C\x0F\xC7\xE3\xF1\xC0",
                "\xFC\x7E\x3F\x1C\x0F\xC7\xE3\xF1\xF8",
                "\xFC\x7E\x3F\x1F\x8E\x07\x03\x81\xC0",
                "\xFC\x7E\x3F\x1F\x8E\x07\x03\x81\xF8",
                "\xFC\x7E\x3F\x1F\x8E\x07\x03\xF1\xC0",
                "\xFC\x7E\x3F\x1F\x8E\x07\x03\xF1\xF8",
                "\xFC\x7E\x3F\x1F\x8E\x07\xE3\x81\xC0",
                "\xFC\x7E\x3F\x1F\x8E\x07\xE3\x81\xF8",
                "\xFC\x7E\x3F\x1F\x8E\x07\xE3\xF1\xC0",
                "\xFC\x7E\x3F\x1F\x8E\x07\xE3\xF1\xF8",
                "\xFC\x7E\x3F\x1F\x8F\xC7\x03\x81\xC0",
                "\xFC\x7E\x3F\x1F\x8F\xC7\x03\x81\xF8",
                "\xFC\x7E\x3F\x1F\x8F\xC7\x03\xF1\xC0",
                "\xFC\x7E\x3F\x1F\x8F\xC7\x03\xF1\xF8",
                "\xFC\x7E\x3F\x1F\x8F\xC7\xE3\x81\xC0",
                "\xFC\x7E\x3F\x1F\x8F\xC7\xE3\x81\xF8",
                "\xFC\x7E\x3F\x1F\x8F\xC7\xE3\xF1\xC0",
                "\xFC\x7E\x3F\x1F\x8F\xC7\xE3\xF1\xF8"];
// This string holds three "zero" bytes [0,0,0]; clears a pixel when written to the frame
const clearString = "\xE0\x70\x38\x1C\x0E\x07\x03\x81\xC0\xE0\x70\x38\x1C\x0E\x07\x03\x81\xC0\xE0\x70\x38\x1C\x0E\x07\x03\x81\xC0";

/* CLASS AND FUNCTION DEFINITIONS --------------------------------------------*/

class neoPixels {
    spi = null;
    frameSize = null;
    frame = null;

    // _spi - A configured spi (MSB_FIRST, 7.5MHz)
    // _frameSize - Number of Pixels per frame
    constructor(_spi, _frameSize) {
        this.spi = _spi;
        this.frameSize = _frameSize;
        this.frame = blob(frameSize*27 + 1);
        
        clearFrame();
        writeFrame();
    }

    // sets a pixel in the frame buffer
    // but does not write it to the pixel strip
    // color is an array of the form [r, g, b]
    function writePixel(p, color) {
        frame.seek(p*BYTESPERPIXEL);
        // red and green are swapped for some reason, so swizzle them back 
        frame.writestring(bits[color[1]]);
        frame.writestring(bits[color[0]]);
        frame.writestring(bits[color[2]]);    
    }
    
    // Clears the frame buffer
    // but does not write it to the pixel strip
    function clearFrame() {
        frame.seek(0);
        for (local p = 0; p < frameSize; p++) frame.writestring(clearString);
        frame.writen(0x00,'c');
    }
    
    // writes the frame buffer to the pixel strip
    // ie - this function changes the pixel strip
    function writeFrame() {
        spi.write(frame);
    }
}

class neoWeather extends neoPixels {
    
    REFRESHPERIOD = 0.05; // effects refresh 10 times per second
    NEWPIXELFACTOR = 1000; // 1/100 pixels will show a new "drop" for a factor 1 effect
    DIMPIXELBY = 1;    // amount to subtract from each color of each lit pixel each refresh
    
    RED     = [16,0,0];
    GREEN   = [0,16,0];
    BLUE    = [0,0,16];
    YELLOW  = [8,8,0];
    CYAN    = [0,8,8];
    MAGENTA = [8,0,8];
    WHITE   = [8,8,8];
    
    pixelvalues = [];
    wakehandle = 0;
    
    constructor(_spi, _frameSize) {
        base.constructor(_spi, _frameSize);
        pixelvalues = [];
        for (local x = 0; x < _frameSize; x++) { pixelvalues.push([0,0,0]); }
    }
    
    function draw() {
        clearFrame();
        for (local pixel = 0; pixel < frameSize; pixel++) {
            writePixel(pixel, pixelvalues[pixel]);
        }
        writeFrame();
    }

    function none() {
        // cancel any previous effect currently running
        imp.cancelwakeup(wakehandle);
        dialvalues = array(_frameSize, [0,0,0]);
        draw();
    }
    
    function rain(factor) {
        //local tick = hardware.micros();
        // cancel any previous effect currently running
        if (wakehandle) { imp.cancelwakeup(wakehandle); }
 
        // schedule refresh
        wakehandle = imp.wakeup((REFRESHPERIOD), function() {rain(factor)}.bindenv(this));
        
        local newdrop = 0;
        local next = false;
        clearFrame();
        for (local pixel = 0; pixel < pixelvalues.len(); pixel++) {
            //server.log(pixel);
            // if there's any color data in this pixel, fade it down 
            next = false;
            if (pixelvalues[pixel][0]) { pixelvalues[pixel][0] -= DIMPIXELBY; next = true;}
            if (pixelvalues[pixel][1]) { pixelvalues[pixel][1] -= DIMPIXELBY; next = true;}
            if (pixelvalues[pixel][2]) { pixelvalues[pixel][2] -= DIMPIXELBY; next = true;}
            // skip random number generation if we just dimmed
            if (!next) {
                newdrop = math.rand() % NEWPIXELFACTOR;
                if (newdrop <= factor) {
                    if (newdrop % 2) {
                        for (local channel = 0; channel < 3; channel++) {
                            pixelvalues[pixel][channel] = BLUE[channel];
                        }
                    } else {
                        for (local channel = 0; channel < 3; channel++) {
                            pixelvalues[pixel][channel] = MAGENTA[channel];
                        }
                    }
                }
            }
            writePixel(pixel, pixelvalues[pixel]);
        }
        writeFrame();
        //local tock = hardware.micros();
        //server.log(format("Refreshed Effect in %d us",(tock-tick)));
    }
    
    function snow(factor) {
        // cancel any previous effect currently running
        imp.cancelwakeup(wakehandle);
    }
    
    function ice(factor) {
        // cancel any previous effect currently running
        imp.cancelwakeup(wakehandle);
    }
    
    function hail(factor) {
        // cancel any previous effect currently running
        imp.cancelwakeup(wakehandle);
    }
    
    function mist(factor) {
        // cancel any previous effect currently running
        imp.cancelwakeup(wakehandle);
    }
    
    function fog(factor) {
        // cancel any previous effect currently running
        imp.cancelwakeup(wakehandle);
    }
    
    function thunder(factor) {
        // cancel any previous effect currently running
        imp.cancelwakeup(wakehandle);
    }
    
    function temp(val, factor) {
        // cancel any previous effect currently running
        imp.cancelwakeup(wakehandle);
    }
}

/* AGENT CALLBACKS -----------------------------------------------------------*/

agent.on("seteffect", function(val) {
    try {
        cond = val.conditions;
        temp = val.temperature;
    } catch (err) {
        server.error("Invalid Request from Agent: "+err);
        return;
    }
    
    if (cond == "drizzle") {
        display.rain(1);
    } else if (cond == "rain") {
        display.rain(100);
    } else if (cond == "snow") {
        display.snow(1);
    } else if (cond == "ice") {
        display.ice(1);
    } else if (cond == "hail") {
        display.hail(1);
    } else if (cond == "mist") {
        display.mist(1);
    } else if (cond == "fog") {
        display.fog(1);
    } else if (cond == "thunderstorm") {
        display.thunder(100);
    } else if (cond == "clear") {
        display.temp(temp, 300);    
    } else if (cond == "mostlycloudy") {
        display.temp(temp, 200); 
    } else if (cond == "partlycloudy") {
        display.temp(temp, 100);
    } else {
        display.temp(temp, 1);
    }
});

/* RUNTIME BEGINS HERE -------------------------------------------------------*/

// The number of pixels in your chain
const NUMPIXELS = 64;

spi <- hardware.spi257;
spi.configure(MSB_FIRST, SPICLK);
display <- neoWeather(spi, NUMPIXELS);

server.log("ready.");
display.rain(50);
server.log("effect started.");
