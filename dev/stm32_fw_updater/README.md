STM32 bootloader class for Electric Imp
==============================
This class allows you to connect an Electric Imp to an external STM32 processor and execute the commands provided in the USART bootloader command set on the STM32. For more information on the STM32 Memory Boot Mode, see [ST AN2606](http://www.st.com/st-web-ui/static/active/en/resource/technical/document/application_note/CD00167594.pdf). 

This class implements the command set detailed in [ST AN3155](http://www.st.com/web/en/resource/technical/document/application_note/CD00264342.pdf).

## Hardware

To use this class, you'll need to connect one of the Imp's UARTs to one of the STM32's bootloader-compatible USARTs. Note that not all of the STM32's USARTs are available for use by the bootloader. 

You'll also need to connect any two Imp pins to BOOT0 and NRST on the STM32. If BOOT1 on the STM32 is not strapped to the correct value to allow the device to enter bootloader mode, you'll need to connect that to any Imp pin as well, and provide it to the Stm32 constructor.

If you're using the STM32F4-Discovery board, you can connect it up with an April board as I did:

| April Pin | STM32 Discovery Board Pin | Description |
| --------- | ------------------------- | ----------- |
| VIN | 5V | Power for April / Imp |
| GND | GND | Ground |
| Pin5 | PB11 | Imp TX / STM32 RX (USART3) |
| Pin7 | PB10 | Imp RX / STM32 TX (USART3) |
| Pin8 | NRST | STM32 Reset, Active-Low |
| Pin9 | BOOT0 | STM32 BOOT0 |

Note: 
- You cannot use STM32 USART1 on the STM32F4 Discovery board because the required pins are already in use on the discovery board
- You cannot use STM32 USART2 on the STM32F4 Discovery board because the STM32F4 does not support USART bootloader on USART2

## Updating Application Code on the STM32 with the Imp

### Convert 

Here are the magic words to convert an intel HEX file (generated by Keil, for example) into a raw binary file ready to be uploaded directly to the STM32. You will need to install the srecord library:

```
14:21:33-tom$ brew install srecord
```

Get your compiler to generate a HEX output file, then convert it with srec_cat:

```
14:26:44-tom$ srec_cat blinky-fast.hex -intel -offset - -minimum-addr blinky-fast.hex -intel -o blinky-fast.bin -binary
```

Note that failing to include the offset by minimum address will create an obscenely large file and make you sad.

### Push directly to the agent

```
14:20:12-tom$ curl --data-binary @blinky.bin https://agent.electricimp.com/<ID>/push
```

### Tell the agent to fetch the file

Include the source url as query parameter:

```
14:20:12-tom$ curl https://agent.electricimp.com/<ID>/fetch?url=<image url>
```